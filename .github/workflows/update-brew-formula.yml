name: Update Brew Formula

on:
  release:
    types: [published]

permissions:
  contents: write
  pull-requests: write

jobs:
  update-formula:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Wait for release artifacts
        run: |
          for i in {1..30}; do
            if gh release download ${{ github.ref_name }} -p "*.sha256" -D /tmp/checksums 2>/dev/null; then
              echo "Artifacts found!"
              exit 0
            fi
            echo "Waiting for artifacts... (attempt $i/30)"
            sleep 2
          done
          echo "Timeout waiting for artifacts"
          exit 1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download checksums
        run: |
          mkdir -p /tmp/checksums
          gh release download ${{ github.ref_name }} -p "*.sha256" -D /tmp/checksums --skip-existing
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract SHAs and update formula
        run: |
          cd /tmp/checksums
          
          # Extract SHA256 values from .sha256 files
          DARWIN_ARM64=$(cat gatekeeper-darwin-arm64.sha256 | awk '{print $1}')
          DARWIN_AMD64=$(cat gatekeeper-darwin-amd64.sha256 | awk '{print $1}')
          LINUX_ARM64=$(cat gatekeeper-linux-arm64.sha256 | awk '{print $1}')
          LINUX_AMD64=$(cat gatekeeper-linux-amd64.sha256 | awk '{print $1}')
          
          echo "DARWIN_ARM64=$DARWIN_ARM64" >> $GITHUB_ENV
          echo "DARWIN_AMD64=$DARWIN_AMD64" >> $GITHUB_ENV
          echo "LINUX_ARM64=$LINUX_ARM64" >> $GITHUB_ENV
          echo "LINUX_AMD64=$LINUX_AMD64" >> $GITHUB_ENV

      - name: Update formula file
        env:
          VERSION: ${{ github.ref_name }}
          DARWIN_ARM64: ${{ env.DARWIN_ARM64 }}
          DARWIN_AMD64: ${{ env.DARWIN_AMD64 }}
          LINUX_ARM64: ${{ env.LINUX_ARM64 }}
          LINUX_AMD64: ${{ env.LINUX_AMD64 }}
        run: |
          python3 << 'EOFPYTHON'
          import os

          version = os.environ.get('VERSION')
          darwin_arm64 = os.environ.get('DARWIN_ARM64')
          darwin_amd64 = os.environ.get('DARWIN_AMD64')
          linux_arm64 = os.environ.get('LINUX_ARM64')
          linux_amd64 = os.environ.get('LINUX_AMD64')

          formula = f"""class Gatekeeper < Formula
            desc "Service authentication status monitor with daemon, CLI, tmux integration, and macOS GUI"
            homepage "https://github.com/retraut/gatekeeper"
            license "MIT"
            version "{version}"

            on_macos do
              on_arm do
                url "https://github.com/retraut/gatekeeper/releases/download/{version}/gatekeeper-darwin-arm64"
                sha256 "{darwin_arm64}"
              end
              on_intel do
                url "https://github.com/retraut/gatekeeper/releases/download/{version}/gatekeeper-darwin-amd64"
                sha256 "{darwin_amd64}"
              end
            end

            on_linux do
              on_arm do
                url "https://github.com/retraut/gatekeeper/releases/download/{version}/gatekeeper-linux-arm64"
                sha256 "{linux_arm64}"
              end
              on_intel do
                url "https://github.com/retraut/gatekeeper/releases/download/{version}/gatekeeper-linux-amd64"
                sha256 "{linux_amd64}"
              end
            end

            def install
              arch = if Hardware::CPU.arm?
                       "arm64"
                     else
                       "amd64"
                     end
              
              os_name = if OS.mac?
                          "darwin"
                        elsif OS.linux?
                          "linux"
                        else
                          "unknown"
                        end
              
              binary_name = "gatekeeper-#{{os_name}}-#{{arch}}"
              bin.install binary_name => "gatekeeper"
            end

            test do
              system "#{{{bin}}}/gatekeeper", "--help"
            end
          end
          """

          with open('Formula/gatekeeper.rb', 'w') as f:
              f.write(formula)
          EOFPYTHON

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "chore: update brew formula to ${{ github.ref_name }}"
          title: "chore: update brew formula to ${{ github.ref_name }}"
          body: "Automatically updated brew formula with new SHA256 checksums for ${{ github.ref_name }}"
          branch: update-brew-formula-${{ github.ref_name }}
          delete-branch: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable auto-merge for Pull Request
        if: steps.cpr.outputs.pull-request-number
        run: |
          gh pr merge ${{ steps.cpr.outputs.pull-request-number }} \
            --auto \
            --squash \
            --delete-branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
