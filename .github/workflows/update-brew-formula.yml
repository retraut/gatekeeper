name: Update Brew Formula

on:
  workflow_run:
    workflows: ["Release"]
    types: [completed]
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  update-formula:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    steps:
      - uses: actions/checkout@v4

      - name: Get latest release tag
        id: release
        run: |
          TAG=$(gh release list --limit 1 --json tagName -q '.[0].tagName')
          echo "tag_name=$TAG" >> $GITHUB_OUTPUT
          echo "Latest release: $TAG"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for release artifacts
        run: |
          for i in {1..30}; do
            if gh release download ${{ steps.release.outputs.tag_name }} -p "*.sha256" -D /tmp/checksums 2>/dev/null; then
              echo "Artifacts found!"
              exit 0
            fi
            echo "Waiting for artifacts... (attempt $i/30)"
            sleep 2
          done
          echo "Timeout waiting for artifacts"
          exit 1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download checksums
        run: |
          mkdir -p /tmp/checksums
          gh release download ${{ steps.release.outputs.tag_name }} -p "*.sha256" -D /tmp/checksums --skip-existing
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract SHAs and update formula
        run: |
          cd /tmp/checksums

          # Extract SHA256 values from .sha256 files
          DARWIN_ARM64=$(cat gatekeeper-darwin-arm64.sha256 | awk '{print $1}')
          LINUX_ARM64=$(cat gatekeeper-linux-arm64.sha256 | awk '{print $1}')
          LINUX_AMD64=$(cat gatekeeper-linux-amd64.sha256 | awk '{print $1}')

          echo "DARWIN_ARM64=$DARWIN_ARM64" >> $GITHUB_ENV
          echo "LINUX_ARM64=$LINUX_ARM64" >> $GITHUB_ENV
          echo "LINUX_AMD64=$LINUX_AMD64" >> $GITHUB_ENV

      - name: Clone tap repository
        run: |
          gh repo clone retraut/homebrew-gatekeeper /tmp/tap
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update formula file in tap
        env:
          VERSION: ${{ steps.release.outputs.tag_name }}
          DARWIN_ARM64: ${{ env.DARWIN_ARM64 }}
          LINUX_ARM64: ${{ env.LINUX_ARM64 }}
          LINUX_AMD64: ${{ env.LINUX_AMD64 }}
        run: |
          python3 << 'EOF_PYTHON'
          import os

          version = os.environ.get('VERSION')
          darwin_arm64 = os.environ.get('DARWIN_ARM64')
          linux_arm64 = os.environ.get('LINUX_ARM64')
          linux_amd64 = os.environ.get('LINUX_AMD64')

          formula = f"""class Gatekeeper < Formula
            desc "Service authentication status monitor with daemon, CLI, and tmux integration"
            homepage "https://github.com/retraut/gatekeeper"
            license "MIT"
            version "{version}"

            on_macos do
              on_arm do
                url "https://github.com/retraut/gatekeeper/releases/download/{version}/gatekeeper-darwin-arm64"
                sha256 "{darwin_arm64}"
              end
            end

            on_linux do
              on_arm do
                url "https://github.com/retraut/gatekeeper/releases/download/{version}/gatekeeper-linux-arm64"
                sha256 "{linux_arm64}"
              end
              on_intel do
                url "https://github.com/retraut/gatekeeper/releases/download/{version}/gatekeeper-linux-amd64"
                sha256 "{linux_amd64}"
              end
            end

            def install
              arch = if Hardware::CPU.arm?
                       "arm64"
                     else
                       "amd64"
                     end

              os_name = if OS.mac?
                          "darwin"
                        elsif OS.linux?
                          "linux"
                        else
                          "unknown"
                        end

              binary_name = "gatekeeper-#{{os_name}}-#{{arch}}"
              bin.install binary_name => "gatekeeper"
            end

            test do
              system "#{{{bin}}}/gatekeeper", "--help"
            end
          end
          """

          with open('/tmp/tap/Formula/gatekeeper.rb', 'w') as f:
              f.write(formula)
          EOF_PYTHON

      - name: Commit and push to tap repository
        run: |
          cd /tmp/tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/gatekeeper.rb
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update formula to ${{ steps.release.outputs.tag_name }}"
            git push
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
